name: Distribute to testers

# Distributes the app via Firebase App Distribution.
# This is the easiest way to get the app on real devices (Android + iOS)
# without publishing to the stores.
#
# Required secrets:
#   FIREBASE_APP_ID_ANDROID  — Firebase Android app ID
#   FIREBASE_APP_ID_IOS      — Firebase iOS app ID
#   FIREBASE_TOKEN           — CI token from `firebase login:ci`
#
# For iOS signing (required):
#   P12_BASE64               — base64 encoded .p12 certificate
#   P12_PASSWORD             — certificate password
#   PROVISIONING_PROFILE_BASE64 — base64 encoded .mobileprovision (Ad Hoc)

on:
  workflow_dispatch:
    inputs:
      platforms:
        description: 'Platforms to distribute'
        required: true
        default: 'both'
        type: choice
        options:
          - android
          - ios
          - both
      testers:
        description: 'Tester emails (comma-separated)'
        required: false
        default: ''
      release_notes:
        description: 'Release notes for testers'
        required: false
        default: 'Nouvelle version de test'

jobs:
  # ──────────────────────────────────────────────
  # Android → Firebase App Distribution
  # ──────────────────────────────────────────────
  distribute-android:
    name: Android → Firebase
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.platforms != 'ios' }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.x'
          channel: stable
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Build APK
        run: flutter build apk --release --no-tree-shake-icons

      - name: Upload to Firebase App Distribution
        uses: wzieba/Firebase-Distribution-Github-Action@v1
        with:
          appId: ${{ secrets.FIREBASE_APP_ID_ANDROID }}
          token: ${{ secrets.FIREBASE_TOKEN }}
          groups: testers
          testers: ${{ github.event.inputs.testers }}
          releaseNotes: |
            ${{ github.event.inputs.release_notes }}

            Commit: ${{ github.sha }}
            Branch: ${{ github.ref_name }}
          file: build/app/outputs/flutter-apk/app-release.apk

  # ──────────────────────────────────────────────
  # iOS → Firebase App Distribution
  # ──────────────────────────────────────────────
  distribute-ios:
    name: iOS → Firebase
    runs-on: macos-latest
    if: ${{ github.event.inputs.platforms != 'android' }}
    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.x'
          channel: stable
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Install CocoaPods
        run: |
          cd ios
          pod install --repo-update || pod install

      - name: Install Apple certificate and provisioning profile
        env:
          P12_BASE64: ${{ secrets.P12_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          PROVISIONING_PROFILE_BASE64: ${{ secrets.PROVISIONING_PROFILE_BASE64 }}
        run: |
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12
          echo "$P12_BASE64" | base64 --decode > "$CERTIFICATE_PATH"
          security import "$CERTIFICATE_PATH" -P "$P12_PASSWORD" \
            -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple: \
            -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH"

          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "$PROVISIONING_PROFILE_BASE64" | base64 --decode \
            > ~/Library/MobileDevice/Provisioning\ Profiles/build.mobileprovision

          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> $GITHUB_ENV

      - name: Build iOS
        run: flutter build ios --release

      - name: Create IPA
        run: |
          mkdir -p build/ios/ipa/Payload
          cp -r build/ios/iphoneos/Runner.app build/ios/ipa/Payload/
          cd build/ios/ipa
          zip -r Runner.ipa Payload

      - name: Upload to Firebase App Distribution
        uses: wzieba/Firebase-Distribution-Github-Action@v1
        with:
          appId: ${{ secrets.FIREBASE_APP_ID_IOS }}
          token: ${{ secrets.FIREBASE_TOKEN }}
          groups: testers
          testers: ${{ github.event.inputs.testers }}
          releaseNotes: |
            ${{ github.event.inputs.release_notes }}

            Commit: ${{ github.sha }}
            Branch: ${{ github.ref_name }}
          file: build/ios/ipa/Runner.ipa

      - name: Clean up keychain
        if: always()
        run: security delete-keychain "$KEYCHAIN_PATH" || true
